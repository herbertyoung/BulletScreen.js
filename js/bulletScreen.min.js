/*
 * bulletscreen.js v1.0.0 - https://github.com/yhb241/BulletScreen.js#readme
 * Copyright (c) 2016 Harbor Young
 * Licensed under the MIT license
 */
function Point(a,b){this.x=a,this.y=b}function Vector2(a,b){Point.call(this,a,b)}Point.prototype={add:function(a){return new Point(this.x+a.x,this.y+a.y)},sub:function(a){return new Point(this.x-a.x,this.y-a.y)}},Point.prototype.constructor=Point,Vector2.prototype=Object.create(Point.prototype),Vector2.prototype.constructor=Vector2,Vector2.prototype.add=function(a){return new Vector2(this.x+a.x,this.y+a.y)},Vector2.prototype.sub=function(a){return new Vector2(this.x-a.x,this.y-a.y)},Vector2.prototype.mult=function(a){return new Vector2(this.x*a,this.y*a)},Vector2.prototype.div=function(a){return new Vector2(this.x/a,this.y/a)},function(a,b){"use strict";function c(b){var c=b.backingStorePixelRatio||b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1;return(a.devicePixelRatio||1)/c}function d(a,b,c,d,f,g,h){2*g>d||2*g>f||(a.save(),a.translate(b,c),e(a,d,f,g),a.fillStyle=h||"black",a.fill(),a.restore())}function e(a,b,c,d){a.beginPath(),a.arc(b-d,c-d,d,0,Math.PI/2),a.lineTo(d,c),a.arc(d,c-d,d,Math.PI/2,Math.PI),a.lineTo(0,d),a.arc(d,d,d,Math.PI,3*Math.PI/2),a.lineTo(b-d,0),a.arc(b-d,d,d,3*Math.PI/2,2*Math.PI),a.closePath()}function f(a){var b,c,d=[],e=a.length;for(c=0;c<e;c++)b=Math.floor(Math.random()*(c+1)),b!==c&&(d[c]=d[b]),d[b]=a[c];return d}function g(a){return this.initial=!1,this.starting=!1,this.runTime=0,this.comments=[],a&&this.init(a),this}var h=a.document,i={canvasWidth:a.innerWidth||h.body.clientWidth||h.documentElement.clientWidth,canvasHeight:a.innerHeight||h.body.clientHeight||h.documentElement.clientHeight,frameRate:30,fontSize:"16px",fontFamily:"Arial",rowSpacing:10,avatarRadius:20,avatarBorder:6,contentBoxHeight:28,contentBoxBorderRadius:6,fontColor:"#fff",backgroundColor:"#fdb720",bulletScreenInterval:3e3};a.BulletScreen=g,g.prototype={init:function(a){if(this.initial)return this;this.initial=!0;for(var b in i)this[b]=i[b];return this.configure(a),this.canvas=this.canvas||h.querySelector("canvas"),this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight,this.context=this.context||this.canvas.getContext("2d"),this.pixelRatio=c(this.context),this.millisecondsPerFrame=parseInt(1e3/this.frameRate),this.calculations={avatarDiameter:2*this.avatarRadius,avatarBoxRadius:this.avatarRadius+this.avatarBorder,contentBoxPositionY:this.contentBoxHeight/-2},this.font=this.fontSize+" "+this.fontFamily,this.rowHeight=Math.max(2*this.calculations.avatarBoxRadius,this.contentBoxHeight),this.maxRow=Math.floor((this.canvasHeight-this.rowSpacing)/(this.rowHeight+this.rowSpacing)),this},_frame:function(){this._render(),this._update(),this.timer=setTimeout(this._frame.bind(this),this.millisecondsPerFrame),this.runTime+=this.millisecondsPerFrame},_update:function(){this._updateComments()},_updateComments:function(){var a,b=this.comments,c=b.length,d=this.maxRow,e=[],g=0,h=!1,i=0;if(this.runTime%this.bulletScreenInterval<this.millisecondsPerFrame){for(h=!0,a=0;a<d;a++)e.push(a);e=f(e)}for(a=0;a<c;a++)h===!0&&b[a].active===!1&&(d-- >0?(g=e.shift(),b[a].position.y+=(this.rowHeight+this.rowSpacing)*g,b[a].active=!0):h=!1),b[a].active===!0&&(b[a].position=b[a].position.add(b[a].velocity.mult(this.millisecondsPerFrame))),b[a].position.x>-(b[a].contentWidth+this.avatarRadius+2*this.avatarBorder)&&(b[i++]=b[a]);b.splice(i,c-i)},_render:function(){var a,b=this.context,c=this.comments,e=this.calculations,f=c.length;for(b.clearRect(0,0,this.canvasWidth,this.canvasHeight),a=0;a<f;a++)c[a].active!==!1&&(b.save(),b.transform(1,0,0,1,c[a].position.x*this.pixelRatio,c[a].position.y*this.pixelRatio),b.beginPath(),b.arc(0,0,e.avatarBoxRadius,0,2*Math.PI),b.closePath(),b.fillStyle=this.backgroundColor,b.fill(),d(b,0,e.contentBoxPositionY,c[a].contentWidth+e.avatarBoxRadius+this.avatarBorder,this.contentBoxHeight,this.contentBoxBorderRadius,this.backgroundColor),b.font=this.font,b.textBaseline="middle",b.fillStyle=this.fontColor,b.fillText(c[a].content,e.avatarBoxRadius,0),b.beginPath(),b.arc(0,0,this.avatarRadius,0,2*Math.PI),b.closePath(),b.strokeStyle="transparent",b.stroke(),b.clip(),b.drawImage(c[a].img,-this.avatarRadius*this.pixelRatio,-this.avatarRadius*this.pixelRatio,e.avatarDiameter*this.pixelRatio,e.avatarDiameter*this.pixelRatio),b.restore())},addComments:function(a){var b=this.context;a.forEach(function(a){var c,d=new Image;d.onload=function(){d.width>0&&d.height>0&&(b.font=this.font,c={position:new Point(this.canvasWidth+Math.floor(100*Math.random()),this.rowHeight/2+this.rowSpacing),velocity:new Vector2(-Math.ceil(5*Math.random()+10)/100,0),active:!1,avatar:a.avatar,content:a.content,contentWidth:b.measureText(a.content).width,img:d},this.comments.push(c))}.bind(this),d.src=a.avatar}.bind(this))},start:function(){this.initial&&(this.starting=!0,this.timer=this.timer||setTimeout(this._frame.bind(this),this.millisecondsPerFrame))},pause:function(){this.starting=!1,clearTimeout(this.timer),this.timer=null},resume:function(){this.start()},clear:function(){clearTimeout(this.timer),this.timer=null,this.context&&this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.comments=[],this.initial=!1,this.starting=!1},configure:function(a){if(a&&"object"==typeof a&&a instanceof Object)for(var b in a)this[b]=a[b]}}}(window);