function Point(a,b){this.x=a,this.y=b}function Vector2(a,b){Point.call(this,a,b)}Point.prototype={add:function(a){return new Point(this.x+a.x,this.y+a.y)},sub:function(a){return new Point(this.x-a.x,this.y-a.y)}},Point.prototype.constructor=Point,Vector2.prototype=Object.create(Point.prototype),Vector2.prototype.constructor=Vector2,Vector2.prototype.add=function(a){return new Vector2(this.x+a.x,this.y+a.y)},Vector2.prototype.sub=function(a){return new Vector2(this.x-a.x,this.y-a.y)},Vector2.prototype.mult=function(a){return new Vector2(this.x*a,this.y*a)},Vector2.prototype.div=function(a){return new Vector2(this.x/a,this.y/a)},function(a,b){"use strict";function c(a,b,c,e,f,g,h){2*g>e||2*g>f||(a.save(),a.translate(b,c),d(a,e,f,g),a.fillStyle=h||"black",a.fill(),a.restore())}function d(a,b,c,d){a.beginPath(),a.arc(b-d,c-d,d,0,Math.PI/2),a.lineTo(d,c),a.arc(d,c-d,d,Math.PI/2,Math.PI),a.lineTo(0,d),a.arc(d,d,d,Math.PI,3*Math.PI/2),a.lineTo(b-d,0),a.arc(b-d,d,d,3*Math.PI/2,2*Math.PI),a.closePath()}function e(a){return this.initial=!1,this.starting=!1,this.runTime=0,this.comments=[],a&&this.init(a),this}var f=a.document,g={canvasWidth:a.innerWidth||f.body.clientWidth||f.documentElement.clientWidth,canvasHeight:a.innerHeight||f.body.clientHeight||f.documentElement.clientHeight,frameRate:30,font:"16px Arial",rowSpacing:10,avatarRadius:20,avatarBorder:6,contentBoxHeight:28,contentBoxBorderRadius:6,fontColor:"#fff",backgroundColor:"#fdb720",bulletScreenInterval:3e3};a.BulletScreen=e,e.prototype={init:function(a){if(this.initial)return this;this.initial=!0;for(var b in g)this[b]=g[b];return this.configure(a),this.canvas=this.canvas||f.querySelector("canvas"),this.context=this.context||this.canvas.getContext("2d"),this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight,this.canvas.style.width=this.canvasWidth+"px",this.canvas.style.height=this.canvasHeight+"px",this.millisecondsPerFrame=parseInt(1e3/this.frameRate),this.calculations={avatarDiameter:2*this.avatarRadius,avatarBoxRadius:this.avatarRadius+this.avatarBorder,contentBoxPositionY:this.contentBoxHeight/-2},this.rowHeight=Math.max(2*this.calculations.avatarBoxRadius,this.contentBoxHeight),this.maxRow=Math.floor((this.canvasHeight-this.rowSpacing)/(this.rowHeight+this.rowSpacing)),this},_frame:function(){this._render(),this._update(),this.timer=setTimeout(this._frame.bind(this),this.millisecondsPerFrame),this.runTime+=this.millisecondsPerFrame},_update:function(){this._updateComments()},_updateComments:function(){var a,b=this.comments,c=b.length,d=this.maxRow,e=[],f=0,g=!1,h=0;if(this.runTime%this.bulletScreenInterval<this.millisecondsPerFrame)for(g=!0,a=0;a<d;a++)e.push(a);for(a=0;a<c;a++)g===!0&&b[a].active===!1&&(d-- >0?(f=e.splice(Math.floor(Math.random()*e.length),1)[0],b[a].position.y+=(this.rowHeight+this.rowSpacing)*f,b[a].active=!0):g=!1),b[a].active===!0&&(b[a].position=b[a].position.add(b[a].velocity.mult(this.millisecondsPerFrame))),b[a].position.x>-(b[a].contentWidth+this.avatarRadius+2*this.avatarBorder)&&(b[h++]=b[a]);b.splice(h,c-h)},_render:function(){var a,b=this.context,d=this.comments,e=this.calculations,f=d.length;for(b.clearRect(0,0,this.canvasWidth,this.canvasHeight),a=0;a<f;a++)d[a].active!==!1&&(b.save(),b.transform(1,0,0,1,d[a].position.x,d[a].position.y),b.beginPath(),b.arc(0,0,e.avatarBoxRadius,0,2*Math.PI),b.closePath(),b.fillStyle=this.backgroundColor,b.fill(),c(b,0,e.contentBoxPositionY,d[a].contentWidth+e.avatarBoxRadius+this.avatarBorder,this.contentBoxHeight,this.contentBoxBorderRadius,this.backgroundColor),b.font=this.font,b.textBaseline="middle",b.fillStyle=this.fontColor,b.fillText(d[a].content,e.avatarBoxRadius,0),b.beginPath(),b.arc(0,0,this.avatarRadius,0,2*Math.PI),b.closePath(),b.strokeStyle="transparent",b.stroke(),b.clip(),b.drawImage(d[a].img,-this.avatarRadius,-this.avatarRadius,e.avatarDiameter,e.avatarDiameter),b.restore())},addComments:function(a){var b=this.context;a.forEach(function(a){var c,d=new Image;d.onload=function(){d.width>0&&d.height>0&&(b.font=this.font,c={position:new Point(this.canvasWidth+Math.floor(100*Math.random()),this.rowHeight/2+this.rowSpacing),velocity:new Vector2(-Math.ceil(5*Math.random()+10)/100,0),active:!1,avatar:a.avatar,content:a.content,contentWidth:b.measureText(a.content).width,img:d},this.comments.push(c))}.bind(this),d.src=a.avatar}.bind(this))},start:function(){this.initial&&(this.starting=!0,this.timer=this.timer||setTimeout(this._frame.bind(this),this.millisecondsPerFrame))},pause:function(){this.starting=!1,clearTimeout(this.timer),this.timer=null},resume:function(){this.start()},clear:function(){clearTimeout(this.timer),this.timer=null,this.context&&this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.comments=[],this.initial=!1,this.starting=!1},configure:function(a){if(a&&"object"==typeof a&&a instanceof Object)for(var b in a)this[b]=a[b]}}}(window);